#!/usr/bin/env python3
"""
Natural Language Mission Planning Agent for KNR DroneController.

Tools are imported from drone_tools.py module.
Uses Anthropic Claude API with LangChain/LangGraph.

Generated missions use DroneController from drone_autonomy package
and are run via: ./run_test_mission.sh or ros2 run
"""

import uuid
import os
from typing import Literal, TypedDict
from datetime import datetime

from langchain_anthropic import ChatAnthropic
from langgraph.types import Command, interrupt
from langgraph.graph import END, START, StateGraph
from langgraph.checkpoint.memory import InMemorySaver

from drone_tools import (
    DRONE_TOOLS,
    ALLOWED_COMMANDS,
    get_tool_descriptions,
    is_valid_command,
    list_tools
)
from dotenv import load_dotenv
load_dotenv()


# ============================================================================
# Data Types
# ============================================================================

class ParsedMission(TypedDict):
    waypoints: list[dict]
    estimated_duration_seconds: int
    max_altitude_meters: float
    max_distance_meters: float
    summary: str
    warnings: list[str]


class MissionValidation(TypedDict):
    is_safe: bool
    requires_confirmation: bool
    issues: list[str]
    risk_level: Literal["low", "medium", "high", "critical"]


class MissionAgentState(TypedDict):
    user_input: str
    language: Literal["pl", "en"] | None
    is_valid_mission: bool | None
    parsed_mission: ParsedMission | None
    validation: MissionValidation | None
    ros2_code: str | None
    mission_id: str | None
    error: str | None
    confirmed: bool
    retry_message: str | None


# ============================================================================
# LLM Setup
# ============================================================================

llm = ChatAnthropic(
    model="claude-sonnet-4-20250514",
    temperature=0,
    max_tokens=4096
)

llm_with_tools = llm.bind_tools(DRONE_TOOLS)


# ============================================================================
# Agent Nodes
# ============================================================================

def validate_user_input(state: MissionAgentState) -> MissionAgentState:
    validation_prompt = f"""Analyze if this text describes a valid drone mission.
A valid drone mission should contain flight commands like:
- takeoff/start/wystartuj
- fly/move/leÄ‡/jedÅº + direction or coordinates
- hover/wait/poczekaj/zawisaj
- land/lÄ…duj
- return home/wrÃ³Ä‡/rtl
- rotate/obrÃ³Ä‡/yaw
- take photo/zrÃ³b zdjÄ™cie/capture

User input: "{state['user_input']}"

Reply ONLY with one word:
- "VALID" if this describes a drone mission
- "INVALID" if this is nonsense or unrelated to drone missions
"""
    
    response = llm.invoke(validation_prompt)
    result = response.content.strip().upper()
    
    if "VALID" in result and "INVALID" not in result:
        return {"is_valid_mission": True, "retry_message": None}
    else:
        lang = state.get("language", "en")
        if lang == "pl":
            msg = "âŒ Nie rozpoznajÄ™ tego jako misji drona. PrzykÅ‚ad: 'wystartuj 10m, leÄ‡ 20m na pÃ³Å‚noc, zrÃ³b zdjÄ™cie, lÄ…duj'"
        else:
            msg = "âŒ I don't recognize this as a drone mission. Example: 'takeoff 10m, fly 20m north, take photo, land'"
        return {"is_valid_mission": False, "retry_message": msg}


def detect_language(state: MissionAgentState) -> MissionAgentState:
    prompt = f"""Detect language. Reply only "pl" or "en".
Text: {state['user_input']}"""
    
    response = llm.invoke(prompt)
    lang = response.content.strip().lower()
    if lang not in ["pl", "en"]:
        lang = "en"
    return {"language": lang}


def parse_mission_with_tools(state: MissionAgentState) -> MissionAgentState:
    tool_descriptions = get_tool_descriptions()
    
    parse_prompt = f"""You are a drone mission planner. Parse the user's mission into a sequence of tool calls.

AVAILABLE TOOLS:
{tool_descriptions}

USER MISSION: {state['user_input']}

RULES:
1. Start with takeoff (required!)
2. Use goto_relative for directions like "fly 10m north" â†’ north=10, east=0, down=0
3. Use goto_global for GPS coordinates
4. Use hover for waiting/holding position
5. Use take_photo when user wants to capture an image
6. End with land or rtl
7. ONLY use tools from the list above

COORDINATE SYSTEM for goto_relative:
- north+ = forward, north- = backward
- east+ = right, east- = left
- down+ = descend, down- = ascend

Parse the mission step by step."""

    try:
        response = llm_with_tools.invoke(parse_prompt)
        
        waypoints = []
        warnings = []
        max_altitude = 0.0
        total_distance = 0.0
        photo_count = 0
        
        if hasattr(response, 'tool_calls') and response.tool_calls:
            for tc in response.tool_calls:
                tool_name = tc['name']
                tool_args = tc['args']
                
                if not is_valid_command(tool_name):
                    warnings.append(f"Ignored unknown command: {tool_name}")
                    continue
                
                waypoint = {"command": tool_name, **tool_args}
                waypoints.append(waypoint)
                
                if tool_name == "takeoff":
                    alt = float(tool_args.get("altitude", 10))
                    max_altitude = max(max_altitude, alt)
                elif tool_name == "goto_relative":
                    north = abs(float(tool_args.get("north", 0)))
                    east = abs(float(tool_args.get("east", 0)))
                    total_distance += (north**2 + east**2)**0.5
                elif tool_name == "goto_global":
                    alt = float(tool_args.get("alt", 10))
                    max_altitude = max(max_altitude, alt)
                elif tool_name == "take_photo":
                    photo_count += 1
        
        if not waypoints:
            return {"error": "Could not parse mission into valid commands"}
        
        summary_prompt = f"Summarize this drone mission in one sentence (max 15 words): {state['user_input']}"
        summary_response = llm.invoke(summary_prompt)
        summary = summary_response.content.strip()
        
        if photo_count > 0:
            summary += f" ({photo_count} photo(s))"
        
        estimated_duration = len(waypoints) * 5
        for wp in waypoints:
            if wp.get("command") == "hover":
                estimated_duration += int(wp.get("hold_time", 0))
        
        parsed_mission: ParsedMission = {
            "waypoints": waypoints,
            "estimated_duration_seconds": estimated_duration,
            "max_altitude_meters": max_altitude,
            "max_distance_meters": total_distance,
            "summary": summary,
            "warnings": warnings
        }
        
        return {"parsed_mission": parsed_mission, "error": None}
        
    except Exception as e:
        return {"error": f"Parse failed: {str(e)}"}


def validate_mission(state: MissionAgentState) -> MissionAgentState:
    if state.get("error"):
        return {}
    
    parsed = state.get("parsed_mission")
    if not parsed:
        return {"error": "No mission"}
    
    issues = []
    risk_level = "low"
    requires_confirmation = False
    
    max_alt = parsed.get("max_altitude_meters", 0)
    if max_alt > 120:
        issues.append(f"Altitude {max_alt}m exceeds 120m legal limit")
        risk_level = "critical"
        requires_confirmation = True
    elif max_alt > 50:
        issues.append(f"High altitude ({max_alt}m)")
        risk_level = "medium"
        requires_confirmation = True
    
    max_dist = parsed.get("max_distance_meters", 0)
    if max_dist > 500:
        issues.append(f"Long distance ({max_dist}m) - check battery")
        risk_level = "medium" if risk_level == "low" else risk_level
        requires_confirmation = True
    
    waypoints = parsed.get("waypoints", [])
    if waypoints:
        last_cmd = waypoints[-1].get("command", "")
        if last_cmd not in ["land", "rtl"]:
            issues.append("Mission does not end with landing")
            requires_confirmation = True
        
        first_cmd = waypoints[0].get("command", "")
        if first_cmd != "takeoff":
            issues.append("Mission does not start with takeoff")
            requires_confirmation = True
    
    if parsed.get("warnings"):
        issues.extend(parsed["warnings"])
        requires_confirmation = True
    
    return {"validation": {
        "is_safe": risk_level != "critical",
        "requires_confirmation": requires_confirmation,
        "issues": issues,
        "risk_level": risk_level
    }}


def generate_ros2_code(state: MissionAgentState) -> MissionAgentState:
    """
    Generuje PROSTY kod ROS2 uÅ¼ywajÄ…cy DroneController.
    Format identyczny jak test_mission.py
    """
    
    if state.get("error"):
        return {}
    
    parsed = state.get("parsed_mission")
    if not parsed:
        return {"error": "No mission"}
    
    waypoints = parsed.get("waypoints", [])
    mission_id = f"mission_{datetime.now().strftime('%Y%m%d_%H%M%S')}"
    
    # SprawdÅº czy misja zawiera zdjÄ™cia
    has_photos = any(wp.get("command") == "take_photo" for wp in waypoints)
    
    # Generuj kod dla kaÅ¼dego waypointa
    mission_lines = []
    photo_idx = 1
    
    for i, wp in enumerate(waypoints):
        cmd = wp.get("command", "")
        
        if not is_valid_command(cmd):
            continue
        
        if cmd == "takeoff":
            altitude = float(wp.get("altitude", 10.0))
            mission_lines.append(f"    mission.takeoff({altitude})")
            mission_lines.append(f"    time.sleep(2)")
            
        elif cmd == "goto_relative":
            north = float(wp.get("north", 0.0))
            east = float(wp.get("east", 0.0))
            down = float(wp.get("down", 0.0))
            mission_lines.append(f"    mission.send_goto_relative({north}, {east}, {down})")
            mission_lines.append(f"    time.sleep(2)")
            
        elif cmd == "goto_global":
            lat = float(wp.get("lat", 0.0))
            lon = float(wp.get("lon", 0.0))
            alt = float(wp.get("alt", 10.0))
            mission_lines.append(f"    mission.send_goto_global({lat}, {lon}, {alt})")
            mission_lines.append(f"    time.sleep(2)")
            
        elif cmd == "hover":
            hold_time = float(wp.get("hold_time", 5.0))
            mission_lines.append(f"    time.sleep({hold_time})")
            
        elif cmd == "set_yaw":
            yaw = float(wp.get("yaw", 0.0))
            relative = wp.get("relative", True)
            yaw_rad = yaw * 3.14159 / 180.0
            mission_lines.append(f"    mission.send_set_yaw({yaw_rad:.4f}, {relative})")
            mission_lines.append(f"    time.sleep(2)")
            
        elif cmd == "set_speed":
            speed = float(wp.get("speed", 5.0))
            mission_lines.append(f"    mission.set_speed({speed})")
            mission_lines.append(f"    time.sleep(1)")
            
        elif cmd == "rtl":
            mission_lines.append(f"    mission.rtl()")
            mission_lines.append(f"    time.sleep(2)")
            
        elif cmd == "land":
            mission_lines.append(f"    mission.land()")
            
        elif cmd == "take_photo":
            prefix = wp.get("prefix", f"photo_{photo_idx}")
            mission_lines.append(f"    take_photo(mission, '{prefix}')")
            mission_lines.append(f"    time.sleep(1)")
            photo_idx += 1
    
    mission_code = "\n".join(mission_lines)
    
    # Import dla zdjÄ™Ä‡
    photo_import = ""
    photo_function = ""
    if has_photos:
        photo_import = "from drone_interfaces.srv import MakePhoto"
        photo_function = '''

def take_photo(node, prefix='photo'):
    """Robi zdjÄ™cie przez serwis /make_photo"""
    client = node.create_client(MakePhoto, '/make_photo')
    if not client.wait_for_service(timeout_sec=2.0):
        node.get_logger().warn('Photo service not available!')
        return False
    
    req = MakePhoto.Request()
    req.prefix = prefix
    req.ext = 'jpg'
    
    future = client.call_async(req)
    rclpy.spin_until_future_complete(node, future, timeout_sec=5.0)
    
    if future.result() is not None:
        result = future.result().success
        node.get_logger().info(f'Photo: {result}')
        return 'saved' in result.lower()
    return False
'''
    
    # Wygeneruj kompletny kod - PROSTY FORMAT jak test_mission.py
    ros2_code = f'''#!/usr/bin/env python3
"""
Auto-generated mission: {mission_id}
Summary: {parsed.get("summary", "N/A")}
"""
import rclpy
import time
from drone_autonomy.drone_comunication import DroneController
{photo_import}
{photo_function}

def main(args=None):
    rclpy.init(args=args)
    mission = DroneController()
    
    mission.arm()
{mission_code}
    
    mission.destroy_node()
    rclpy.shutdown()

if __name__ == "__main__":
    main()
'''
    
    return {"ros2_code": ros2_code, "mission_id": mission_id}


# ============================================================================
# Routing Functions
# ============================================================================

def route_after_input_validation(state: MissionAgentState) -> Literal["parse_mission_with_tools", "__end__"]:
    if state.get("is_valid_mission"):
        return "parse_mission_with_tools"
    return "__end__"


def route_after_validation(state: MissionAgentState) -> Literal["human_review", "generate_ros2_code", "__end__"]:
    if state.get("error"):
        return "__end__"
    
    validation = state.get("validation", {})
    if validation.get("requires_confirmation"):
        return "human_review"
    return "generate_ros2_code"


def human_review(state: MissionAgentState) -> Command[Literal["generate_ros2_code", END]]:
    parsed = state.get("parsed_mission", {})
    validation = state.get("validation", {})
    
    review_info = {
        "summary": parsed.get("summary", "N/A"),
        "risk": validation.get("risk_level", "?"),
        "issues": validation.get("issues", []),
        "waypoints": len(parsed.get("waypoints", [])),
    }
    
    human_decision = interrupt(review_info)
    
    if human_decision.get("approved", False):
        return Command(update={"confirmed": True}, goto="generate_ros2_code")
    return Command(update={"error": "Rejected by user"}, goto=END)


def output_result(state: MissionAgentState) -> MissionAgentState:
    return {}


# ============================================================================
# Build Graph
# ============================================================================

def build_mission_graph():
    builder = StateGraph(MissionAgentState)
    
    builder.add_node("detect_language", detect_language)
    builder.add_node("validate_user_input", validate_user_input)
    builder.add_node("parse_mission_with_tools", parse_mission_with_tools)
    builder.add_node("validate_mission", validate_mission)
    builder.add_node("human_review", human_review)
    builder.add_node("generate_ros2_code", generate_ros2_code)
    builder.add_node("output_result", output_result)
    
    builder.add_edge(START, "detect_language")
    builder.add_edge("detect_language", "validate_user_input")
    
    builder.add_conditional_edges(
        "validate_user_input",
        route_after_input_validation,
        ["parse_mission_with_tools", "__end__"]
    )
    
    builder.add_edge("parse_mission_with_tools", "validate_mission")
    
    builder.add_conditional_edges(
        "validate_mission",
        route_after_validation,
        ["human_review", "generate_ros2_code", "__end__"]
    )
    
    builder.add_edge("generate_ros2_code", "output_result")
    builder.add_edge("output_result", END)
    
    return builder.compile(checkpointer=InMemorySaver())


# ============================================================================
# CLI
# ============================================================================

def print_banner():
    print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘       ğŸš KNR Drone Mission Planner (Natural Language)            â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  Examples:                                                        â•‘
â•‘  â€¢ "takeoff 10m, fly 20m north, hover 5s, land"                  â•‘
â•‘  â€¢ "wystartuj 15m, leÄ‡ 30m pÃ³Å‚noc, zrÃ³b zdjÄ™cie, lÄ…duj"          â•‘
â•‘                                                                   â•‘
â•‘  Commands: 'quit' | 'help' | 'tools'                             â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """)


def get_output_dir():
    return os.path.dirname(os.path.abspath(__file__))


def run_interactive():
    print_banner()
    app = build_mission_graph()
    output_dir = get_output_dir()
    
    print(f"ğŸ“ Output directory: {output_dir}\n")
    
    while True:
        try:
            user_input = input("ğŸ¯ Mission: ").strip()
            
            if not user_input:
                continue
            if user_input.lower() in ['quit', 'exit', 'q']:
                break
            if user_input.lower() == 'tools':
                list_tools()
                continue
            if user_input.lower() == 'help':
                print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                        HELP - Commands                            â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  ACTIONS:                                                         â•‘
â•‘    takeoff Xm      â†’ Start and rise to X meters                  â•‘
â•‘    fly Xm north    â†’ Move X meters in direction                  â•‘
â•‘    hover Xs        â†’ Hold position for X seconds                 â•‘
â•‘    take photo      â†’ Capture image from camera                   â•‘
â•‘    rotate XÂ°       â†’ Rotate by X degrees                         â•‘
â•‘    return home     â†’ Return to start position (rtl)              â•‘
â•‘    land            â†’ Land at current position                    â•‘
â•‘                                                                   â•‘
â•‘  EXAMPLES:                                                        â•‘
â•‘    "takeoff 10m, fly 20m north, take photo, land"                â•‘
â•‘    "wystartuj 15m, leÄ‡ na wschÃ³d, zrÃ³b zdjÄ™cie, lÄ…duj"           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                """)
                continue
            
            config = {"configurable": {"thread_id": str(uuid.uuid4())}}
            
            initial_state = {
                "user_input": user_input,
                "language": None,
                "is_valid_mission": None,
                "parsed_mission": None,
                "validation": None,
                "ros2_code": None,
                "mission_id": None,
                "error": None,
                "confirmed": False,
                "retry_message": None
            }
            
            print("â³ Processing mission...")
            result = app.invoke(initial_state, config)
            
            if result.get("retry_message"):
                print(result["retry_message"])
                continue
            
            if "__interrupt__" in result:
                data = result["__interrupt__"][0].value
                print(f"\nâš ï¸  Review required!")
                print(f"   Risk level: {data.get('risk', 'unknown')}")
                print(f"   Issues: {', '.join(data.get('issues', ['None']))}")
                confirm = input("\n   Approve mission? (y/n): ").strip().lower()
                result = app.invoke(
                    Command(resume={"approved": confirm in ['y', 'yes']}), 
                    config
                )
            
            if result.get("error"):
                print(f"âŒ Error: {result['error']}")
            elif result.get("ros2_code"):
                mission_id = result['mission_id']
                pm = result.get("parsed_mission", {})
                
                print(f"\nâœ… Mission generated: {mission_id}")
                print(f"ğŸ“ Summary: {pm.get('summary', 'N/A')}")
                print(f"ğŸ“ Waypoints ({len(pm.get('waypoints', []))}):")
                
                for i, wp in enumerate(pm.get('waypoints', [])):
                    cmd = wp.get('command', '?')
                    params = {k: v for k, v in wp.items() if k != 'command'}
                    params_str = ', '.join(f"{k}={v}" for k, v in params.items()) if params else ""
                    icon = "ğŸ“·" if cmd == "take_photo" else "ğŸ“"
                    print(f"   {icon} {i+1}. {cmd}({params_str})")
                
                save = input("\nğŸ’¾ Save mission? (y/n): ").strip().lower()
                if save in ['y', 'yes']:
                    filepath = os.path.join(output_dir, f"{mission_id}.py")
                    with open(filepath, 'w', encoding='utf-8') as f:
                        f.write(result['ros2_code'])
                    os.chmod(filepath, 0o755)
                    
                    print(f"\nâœ… Saved: {filepath}")
                    print(f"\nğŸ“¦ To run:")
                    print(f"   1. Copy to docker drone_autonomy folder")
                    print(f"   2. Run: ./run_test_mission.sh")
                    print(f"   Or modify run_test_mission.sh to point to {mission_id}.py")
                    
        except KeyboardInterrupt:
            print("\n")
            break
        except Exception as e:
            print(f"âŒ Error: {e}")
            import traceback
            traceback.print_exc()
    
    print("ğŸ‘‹ Goodbye!")


if __name__ == "__main__":
    run_interactive()